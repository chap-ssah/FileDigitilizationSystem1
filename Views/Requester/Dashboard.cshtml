@model FileDigitilizationSystem.Models.RequesterDashboardViewModel
@{
    ViewData["Title"] = "Requester Dashboard";
    Layout = "~/Views/Shared/_RequesterLayout.cshtml"; // Use dedicated requester layout
}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>FILE SEARCH</h2>
    
</div>

<!-- Search Functionality -->
<div class="card mb-4">
    <div class="card-body">
        <form asp-action="Search" method="get" class="row g-2 align-items-end">
            <div class="col-md-6">
                <label class="form-label">Search Files</label>
                <input name="q" class="form-control" placeholder="Search by File Ref, Location, or Applicant ID/Name" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Location</label>
                <select name="location" class="form-select">
                    <option value="">All</option>
                    <option>Glen View</option>
                    <option>Budiriro</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check form-check-inline mt-4 pt-2">
                    <input class="form-check-input" type="checkbox" name="digitized" id="digital" />
                    <label class="form-check-label" for="digital">Digital Files</label>
                </div>
                <div class="form-check form-check-inline mt-4 pt-2">
                    <input class="form-check-input" type="checkbox" name="physical" id="physical" />
                    <label class="form-check-label" for="physical">Physical Files</label>
                </div>
                <button type="submit" class="btn btn-primary ms-3 mt-4">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </form>
    </div>
</div>
<!-- No-Results Alert (new) -->
@if (Model.NoResults)
{
    <div class="alert alert-warning">
        No files found matching "@Model.SearchQuery".
        <a asp-action="RequestMissing" asp-route-reference="@Model.SearchQuery">Request this file</a>
        from our Records Team.
    </div>
}

<!-- Search Results -->
@if (Model.SearchResults != null && Model.SearchResults.Any())
{
    <h4>Search Results</h4>
    <div class="table-responsive mb-4">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Reference</th>
                    <th>ApplicantName</th>
                    <th>Suburb</th>
                    <th>Land Use Type</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var file in Model.SearchResults)
                {
                    <tr>
                        <td>@file.Reference</td>
                        <td>@file.ApplicantName</td>
                        <td>@file.Location</td>

                        <td>@file.LandUseType</td>
                        <td>@(file.IsDigital ? "Digital" : "Physical")</td>
                        <td class="text-end">
                            @if (file.IsDigital)
                            {
                                <a asp-action="Download"
                                   asp-route-id="@file.Id"
                                   class="btn btn-sm btn-success">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-warning"
                                        data-bs-toggle="modal"
                                        data-bs-target="#requestDigitizeModal"
                                        data-fileid="@file.Id">
                                    <i class="bi bi-file-earmark-arrow-up"></i> Request Digitization
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}


<!-- Request Digitization Modal -->


<!-- Notifications & Recent Requests -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card mb-3 h-100" style="background-color:#ffeeba;">
            <div class="card-header">Notifications</div>
            <div class="card-body">
                @if (Model.Notifications.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var note in Model.Notifications)
                        {
                            <li class="list-group-item">
                                <i class="bi bi-bell-fill me-2"></i>
                                @note.Message
                                <span class="text-muted small float-end">@note.Timestamp.ToString("g")</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>No notifications at this time.</p>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-3 h-100" style="background-color:#d1ecf1;">
            <div class="card-header">Recent Requests</div>
            <div class="card-body">
                @if (Model.RecentRequests.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var req in Model.RecentRequests)
                        {
                            <li class="list-group-item">
                                <strong>@req.Reference</strong> - @(req.Handled ? "Completed" : "Pending")

                                <span class="text-muted small float-end">@req.CreatedAt.ToString("g")</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>No recent requests.</p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var reqModal = document.getElementById('requestDigitizeModal');
        reqModal.addEventListener('show.bs.modal', function (e) {
            var btn = e.relatedTarget;
            var fileId = btn.getAttribute('data-fileid');
            reqModal.querySelector('#modalFileId').value = fileId;
        });
    </script>
}
